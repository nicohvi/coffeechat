// Generated by CoffeeScript 1.7.1
(function() {
  $(function() {
    var $input, $messageInput, $messages, $username, addChatMessage, addMessageElement, addSystemMessage, addUser, connected, sendMessage, socket, username;
    socket = io();
    connected = false;
    $messages = $('.messages');
    $username = $('.username-input');
    $messageInput = $('.new-message');
    $input = $username.focus();
    username = null;
    addUser = function() {
      username = $username.val().trim();
      if (username) {
        $input = $messageInput.focus();
        return socket.emit('add user', username);
      }
    };
    sendMessage = function() {
      var message;
      message = $input.val();
      if (connected) {
        $input.val('');
        addChatMessage({
          username: username,
          message: message
        });
        return socket.emit('new message', message);
      }
    };
    addChatMessage = function(data, options) {
      var $messageBodyEl, $messageEl, $userEl;
      $userEl = $('<span class="username" />').text(data.username);
      $messageBodyEl = $('<span class="message-body" />').text(data.message);
      $messageEl = $('<li class="message" />').data('username', data.username).append($userEl, $messageBodyEl);
      return addMessageElement($messageEl, options);
    };
    $(this).keydown(function(event) {
      if (event.which === 13) {
        if (username != null) {
          return sendMessage();
        } else {
          return addUser();
        }
      }
    });
    addSystemMessage = function(message, options) {
      var $messageBodyEl, $messageEl;
      $messageBodyEl = $('<span class="message-body" />').text(message);
      $messageEl = $('<li class="message system"/>').append($messageBodyEl);
      return addMessageElement($messageEl, options);
    };
    addMessageElement = function($el, options) {
      if (options == null) {
        options = {};
      }
      if (options.prepend) {
        $messages.prepend($el);
      } else {
        $messages.append($el);
      }
      return $messages[0].scrollTop = $messages[0].scrollHeight;
    };
    socket.on('login', function(data) {
      var message;
      connected = true;
      message = "Welcome to Coffeechat, " + data.username + ".";
      return addSystemMessage(message, {
        prepend: true
      });
    });
    socket.on('user joined', function(data) {
      var message;
      message = "" + data.username + " has joined the chat. There are now " + data.numUsers + " connnected.";
      return addSystemMessage(message);
    });
    return socket.on('new message', function(data) {
      return addChatMessage(data);
    });
  });

}).call(this);
